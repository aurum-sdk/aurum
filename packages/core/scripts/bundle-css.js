/**
 * Pre-build script that bundles all CSS files into a single TypeScript file
 * for Shadow DOM injection. Automatically discovers all .css files in src/.
 */
const fs = require('fs');
const path = require('path');

const srcDir = path.resolve(__dirname, '../src');
const outputFile = path.resolve(srcDir, 'styles/bundledStyles.ts');

// Recursively find all CSS files in a directory
function findCssFiles(dir, files = []) {
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      findCssFiles(fullPath, files);
    } else if (entry.name.endsWith('.css')) {
      files.push(fullPath);
    }
  }
  return files;
}

// Find all CSS files and sort them (globals.css first for proper cascade)
const cssFiles = findCssFiles(srcDir).sort((a, b) => {
  // globals.css should always be first
  if (a.includes('globals.css')) return -1;
  if (b.includes('globals.css')) return 1;
  return a.localeCompare(b);
});

// Read and concatenate all CSS files
let bundledCss = '';
for (const filePath of cssFiles) {
  const relativePath = path.relative(srcDir, filePath);
  const content = fs.readFileSync(filePath, 'utf8');
  bundledCss += `/* ${relativePath} */\n${content}\n\n`;
}

// Generate TypeScript file with CSS as string literal
const tsContent = `/**
 * Auto-generated file containing all SDK styles bundled as a string.
 * This file is generated by scripts/bundle-css.js
 * DO NOT EDIT MANUALLY
 */
export const bundledStyles = ${JSON.stringify(bundledCss)};
`;

// Ensure output directory exists
const outputDir = path.dirname(outputFile);
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

// Write the output file
fs.writeFileSync(outputFile, tsContent, 'utf8');
// eslint-disable-next-line no-console
console.log(`Bundled ${cssFiles.length} CSS files into ${outputFile}`);
